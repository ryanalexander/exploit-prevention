import {Command, Managers} from '../../lib/libaries';
import {GuildMember, Message, MessageEmbed} from 'discord.js';
import {getMessage, lang} from "../../lib/LanguageLib";

module.exports = class extends Command {
    constructor() {
        super({
            name: "settings",
            aliases: ["setting", "config", "prefs", "preferences"],
            description: "Settings menu",
            category: "admin"
        });
        this._execute = this.execute;
    }

    async execute(_member: GuildMember, _content: string, _message: Message) {
        let embed = new MessageEmbed();
        let args = _content.split(" ");

        if(!_member.hasPermission("MANAGE_GUILD")) {
            _message.channel.send(getMessage(lang.messages.errors.permission, [{type:"DISCORD_PERM_NODE",value:"MANAGE_GUILD"}]));
            return;
        }

        if(args[1] === undefined) {
            embed.setTitle("Settings help menu")
            embed.addField("prefix", `Set the prefix for my commands.`, true)
            embed.addField("messages", `Customize my responses`, true)
            embed.addField("logs", `Set the logs channel for when i detect something.`, true)
            embed.addField("action", `What should i do when i find a crash video?`, true)
        }else {
            switch (args[1].toUpperCase()) {
                case "PREFIX":
                case "SETPREFIX":
                case "CHANGEPREFIX":
                    embed.setTitle("Prefix settings")
                    if(args[2] === undefined || args[2] === null) {
                        embed.setDescription(`Correct usage: ${this._guild.prefix}settings prefix [prefix]`);
                        embed.setFooter("You can always @ me to find current prefix")
                    }else {
                        embed.setDescription(`I will now respond to the prefix \`${args[2]}\``);
                        Managers.GuildManager.setPrefix(_message.guild, args[2]);
                    }
                    break;
                case "MESSAGES":
                    embed.setTitle("Messages settings")
                    embed.setDescription("This functionallity is coming soon.")
                    break;
                case "LOG-CHANNEL":
                case "LOGS":
                    embed.setTitle("Logging settings")
                    if(args[2] === undefined || args[2] === null) {
                        embed.setDescription(`Correct usage: Eg. ${this._guild.prefix}settings logs ${_message.channel}`);

                        try {
                            let channel = await Managers.DiscordClient.channels.fetch(this._guild.log_channel);

                            embed.addField("Current channel", channel ? channel : "Not set")
                        }catch (e) {
                            embed.addField("Current channel", "Not set")
                        }
                    }else {
                        if(_message.mentions.channels.first()) {
                            embed.setDescription(`I will now log to ${_message.mentions.channels.first()}`)
                            embed.setFooter("Type 'none' as the channel to disable")
                        }else {
                            embed.setDescription(`I will no longer log crash messages`)
                        }
                        Managers.GuildManager.setLogs(_message.guild, _message.mentions.channels.first());
                    }
                    break;
                case "ACTION":
                    let actions = ["WARN","REPOST","DELETE"];
                    embed.setTitle("Action settings");
                    if(args[2] === undefined || args[2] === null) {
                        embed = getMessage(lang.messages.settings.action.usage, [{
                            type: "BOT_GUILD_CURRENT_ACTION",
                            value: `${actions[this.guild.detect_action]}`
                        }]);
                    }else if(actions.indexOf(args[2].toUpperCase()) <=-1){
                        embed = getMessage(lang.messages.settings.action.usage, []);
                    }else {
                        embed = getMessage(lang.messages.settings.action.set, [
                            {
                                type: "SELECTED_ACTION_DESC",
                                value: lang.generic.actions[args[2].toUpperCase()]
                            }
                        ])
                        Managers.GuildManager.setAction(_message.guild, actions.indexOf(args[2].toUpperCase()));
                    }
                    break;
            }
        }
        _message.channel.send(embed);
    };

}