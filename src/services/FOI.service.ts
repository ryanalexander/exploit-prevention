import { Managers } from "../lib/libaries";
import { MessageAttachment, User } from "discord.js";

export default class {
  interval = 30;
  constructor() {
    this.interval = this.interval * 1000;

    console.log("FOI service started");

    setInterval(async () => {
      this.handle();
    }, this.interval);
  }

  async handle() {
    let completed = await Managers.SQL.fetchFOIdone();

    completed.map(async (row: any) => {
      let user: User = await Managers.DiscordClient.users.fetch(
        `${row.user_id}`
      );
      if (!user) {
        console.log(`Unknown ${row.user_id}`);
        return;
      }
      try {
        let attachment = new MessageAttachment(
          Buffer.from(row.file_out),
          "data_export.json"
        );
        (await user.createDM()).send({
          content:
            "As requested, we have supplied a file containing all the data we are storing for you.",
          files: [attachment],
        });
      } catch (e) {
        console.log(e);
      }
    });
  }
}
