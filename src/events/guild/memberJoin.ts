import {Event, Managers} from '../../lib/libaries';
import {GuildMember} from "discord.js";

module.exports = class extends Event {
    constructor() {
        super({
            event: "guildMemberJoin",
        });
        this._execute = this.execute;
    }

    async execute(member: GuildMember) {
        let guild = await Managers.GuildManager.getGuildOrCreate(member.guild);
        if(guild.modules.indexOf("invitetrack") <= -1)return;
        let invites = await member.guild.fetchInvites();
        let cachedInvites = await Managers.SQL.getInvitesForGuild(member.guild.id)

        // @ts-ignore
        const invite = invites.find(i => cachedInvites.rows.find(invite => invite.code === i.code).get(i.code)!==undefined&&(cachedInvites.rows.find(invite => invite.code === i.code).uses < i.uses));
        if(invite)
            console.log(invite.inviter?.id);
    }

}