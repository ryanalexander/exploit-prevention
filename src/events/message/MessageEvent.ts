import { Event, Managers } from "../../lib/libaries";
import { Message, TextChannel } from "discord.js";
// @ts-ignore
import nvt from "node-virustotal";
import { SyrusGuild } from "../../managers/GuildManager";

module.exports = class extends Event {
  constructor() {
    super({
      event: "messageCreate",
    });
    this._execute = this.execute;
  }

  async execute(message: Message) {
    //let RedisClient: any = Managers.RedisClient;
    Managers.SQL.query(
      "INSERT INTO ep_message_log (id, channel_id, content, guild_id, time, user_id) VALUES (?, ?, ?, ?, ? ,?)",
      [
        message.id,
        message.channel.id,
        message.content,
        message.guild?.id,
        new Date(),
        message.author.id,
      ]
    );
    if (!message.guild || message.author.bot) return;
    try {
      let guild: SyrusGuild = await Managers.GuildManager.getGuildOrCreate(
        message.guild
      );
      Managers.SQL.registerUser(message.author, message.guild);
      if (message.member) Managers.SQL.registerGuildUser(message.member, null);

      if (
        message.mentions.users.size === 1 &&
        message.mentions.has(Managers.DiscordClient.user.id) &&
        message.guild.me
          ?.permissionsIn(<TextChannel>message.channel)
          .has("SEND_MESSAGES")
      ) {
        message.reply(`My prefix here is \`${guild.prefix}\``);
        return;
      }

      if (
        message.content.startsWith(guild.prefix) &&
        message.guild.me
          ?.permissionsIn(<TextChannel>message.channel)
          .has("SEND_MESSAGES")
      )
        Managers.CommandManager.handle(message, guild);

      Managers.ModuleManager.filterModulesByEvent(
        guild.modules,
        "messageCreate"
      ).forEach(
        (module: {
          onMessageReceive: (message: Message, guild: SyrusGuild) => void;
        }) => module.onMessageReceive(message, guild)
      );
    } catch (e) {
      console.log(e);
    }
  }
};
